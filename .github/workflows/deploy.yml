name: Deploy CarLedgr to VPS

on:
  push:
    branches: [master]
  workflow_dispatch:  # Allow manual triggering

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      website: ${{ steps.changes.outputs.website }}
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
      caddy: ${{ steps.changes.outputs.caddy }}
      deploy-scripts: ${{ steps.changes.outputs.deploy-scripts }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect changed files
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            website:
              - 'website/**'
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'
            caddy:
              - 'Caddyfile'
            deploy-scripts:
              - 'server-deployment/**'

  deploy:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: ${{ needs.detect-changes.outputs.website == 'true' || needs.detect-changes.outputs.frontend == 'true' || needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.caddy == 'true' || needs.detect-changes.outputs.deploy-scripts == 'true' }}
    
    steps:
      - name: Setup SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.VPS_SSH_KEY }}
          known_hosts: ${{ secrets.VPS_HOST }}
          
      - name: Add known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          
      - name: Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            echo "ðŸš€ Starting deployment..."
            echo "Changes detected:"
            echo "  Website: ${{ needs.detect-changes.outputs.website }}"
            echo "  Frontend: ${{ needs.detect-changes.outputs.frontend }}"
            echo "  Backend: ${{ needs.detect-changes.outputs.backend }}"
            echo "  Caddy: ${{ needs.detect-changes.outputs.caddy }}"
            echo "  Deploy Scripts: ${{ needs.detect-changes.outputs.deploy-scripts }}"
            
            cd /var/www/carledgr
            sudo -u deploy ./server-deployment/deploy-update.sh \
              --website=${{ needs.detect-changes.outputs.website }} \
              --frontend=${{ needs.detect-changes.outputs.frontend }} \
              --backend=${{ needs.detect-changes.outputs.backend }} \
              --caddy=${{ needs.detect-changes.outputs.caddy }} \
              --deploy-scripts=${{ needs.detect-changes.outputs.deploy-scripts }}
          EOF

      - name: Health Check
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd /var/www/carledgr
            ./server-deployment/health-check.sh
          EOF

      - name: Notify Success
        if: success()
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ Website: https://carledgr.com"
          echo "ðŸš€ App: https://app.carledgr.com"
          echo "ðŸ§ª Demo: https://demo.carledgr.com"

      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Check the logs above for details." 